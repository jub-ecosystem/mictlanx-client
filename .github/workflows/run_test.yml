name: Run Unit Test via Pytest  
  
on:
  push: 
    branches: ["*"]
  pull_request:
    branches: ["*"]
    paths:
      - "mictlanx/**"
      - "tests/**"
      - "pyproject.toml"
  
  
jobs:  
  build:  
    runs-on: ubuntu-latest  
    env:
      MICTLANX_LOG_PATH: ${{ github.workspace }}/mictlanx/client
    strategy:  
      matrix:  
        python-version: ["3.9"]  
    steps:  
      - uses: actions/checkout@v3  
      - name: Set up Python ${{ matrix.python-version }}  
        uses: actions/setup-python@v4  
        with:  
          python-version: ${{ matrix.python-version }}  
      - name: Install Poetry
        run: |
          curl -sSL https://install.python-poetry.org | python3 -
          echo "$HOME/.local/bin" >> $GITHUB_PATH  # Ensure poetry is on PATH
      - name: Prepare log folder
        run: |
          mkdir -p "${MICTLANX_LOG_PATH}"
      - name: Start MictlanX Peer
        run: |
          chmod +x deploy_peer.sh && ./deploy_peer.sh
      - name: Wait for Peer to be ready
        run: |
          echo "Waiting for MictlanX Peer to respond on port 25000..."
          for i in {1..15}; do
            if curl -fsS http://localhost:25000/health >/dev/null; then
              echo "✅ Peer is up!"
              break
            fi
            echo "⏳ Peer not ready yet... ($i)"
            sleep 2
          done
      - name: Start MictlanX Router
        run: |
          chmod +x deploy_router.sh && ./deploy_router.sh
      - name: Wait for Router to be ready
        run: |
          echo "Waiting for MictlanX Router to respond on port 60666..."
          for i in {1..15}; do
            if curl -fsS http://localhost:60666/docs >/dev/null; then
              echo "✅ Router is up!"
              break
            fi
            echo "⏳ Router not ready yet... ($i)"
            sleep 2
          done
      - name: Configure Poetry
        run: |
          mkdir -p ~/.config/pypoetry
          poetry config virtualenvs.create true --local
          poetry config virtualenvs.in-project true --local

